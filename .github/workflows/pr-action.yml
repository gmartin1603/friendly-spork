#################################################################################
# Name: OTM-Develop-PR-Action
# Author: George Martin
# Date: 2024-01-20
# Notes:
#  This workflow is triggered when a pull request is opened or updated.
# Environment Variables:
#  OTA_DIR
#  CONFIG
#  BASEURL
################################################################################

name: Test-Build
on:
  pull_request:
    branches: [ "develop" ]
  workflow_dispatch:
jobs:
  install:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install Node
      uses: actions/setup-node@v3
      with:
        node-version: '21'

    - name: Setup .env file
      run: echo "${{ secrets.ENV_CONTENTS }}" > .env

    - name: Setup cypress.env.json
      run: echo '${{ secrets.CYPRESS_ENV }}' > cypress.env.json

    # Validate cypress.env.json
    - name: Validate cypress.env.json
      run: |
        cat cypress.env.json
        jq empty cypress.env.json

    - name: Create private directory
      run: mkdir -p ./src/private

    - name: Create Firestore Config File
      run: |
        echo "export const firebaseConfig = {};" > ./src/private/firestore.js
        echo "export const firebaseConfig2 = ${FIREBASE_CONFIG_JSON};" >> ./src/private/firestore.js
      env:
        FIREBASE_CONFIG_JSON: ${{ secrets.FIREBASE_CONFIG }}

    - name: Setup Firebase Admin Config
      run: |
        echo "${{ secrets.FIREBASE_ADMIN_CONFIG }}" > ./src/private/firebase_admin.json

    - name: Install Dependencies
      run: npm install --legacy-peer-deps

    - name: Build
      run: npm run build

    - name: Install http-server
      run: npm install -g http-server

    - name: Serve and Test
      run: |
        http-server build & 
        sleep 10
        npm run test admin 

    - name: Upload test results
      uses: actions/upload-artifact@v2
      with:
        name: test-results
        path: cypress/report/results_report.html
